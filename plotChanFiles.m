
function plotChanFiles( varargin )

% Plot event rate vs position on probe, either for a single *_chan.txt file
% or multiple files. When calling

if (length(varargin) == 0)
    % set probe type and list of chan.txt (generated by detect_merge_peaks and
    % allSpike) files manually.
    % you can load as many *_chan.txt files as you like
    % If sites overlap, value at that site will be the last file loaded.
    pType = 24;
    % fname{1} = "Z:\CB_NP24\catgt_anm_110_20190807_shank0_bottomrow128_g0\anm_110_20190807_shank0_bottomrow128_g0_tcat.imec0.ap_chan.txt";
    % fname{2} = "Z:\CB_NP24\catgt_anm_110_20190807_shank1_bottomrow128_g0\anm_110_20190807_shank1_bottomrow128_g0_tcat.imec0.ap_chan.txt";
    % fname{3} = "Z:\CB_NP24\catgt_anm_110_20190807_shank2_bottomrow128_g0\anm_110_20190807_shank2_bottomrow128_g0_tcat.imec0.ap_chan.txt";
    % fname{4} = "Z:\CB_NP24\catgt_anm_110_20190807_shank3_bottomrow128_g0\anm_110_20190807_shank3_bottomrow128_g0_tcat.imec0.ap_chan.txt";
    fname{1} = "Z:\JP_NP24_test\catgt_WR39_100819_g0\WR39_100819_g0_tcat.imec0.ap_chan.txt";
else
    % read probe type and a single filename from the input arguments
    inputCell = varargin(1);
    pType = inputCell{1};
    for j = 2:numel(varargin)
        inputCell = varargin(2);
        fname{j-1} = inputCell{1};
    end
    
end

% initialize variables
i = 0;

shank = [];
x = [];
y = [];
chan = [];
rms = [];
evtRate = [];

for iFile = 1:numel(fname)
    
    fid = fopen( fname{iFile}, 'r');
    %read header line
    tline = fgetl(fid);

    while ~feof(fid)
        tline = fgetl(fid);
        i = i + 1;
        cArray = textscan(tline, '%d\t%f\t%f\t%d\t%f\t%f\t%f\t%f\t%f');
        shank(i) = cArray{1};
        x(i) = cArray{2};
        y(i) = cArray{3};
        chan(i)= cArray{4};
        rms(i) = cArray{5};
        evtRate(i) = cArray{6};
    end
    fclose(fid);

end

XYPlot20(pType, shank, x, y, evtRate);

end


% =========================================================
% plot data on top of all for electrode positions for 2.0
%
% 
function XYPlot20(pType, shankind, xCoord, yCoord, data)   

   
    nElec = 1280;   %per shank; pattern repeats for the four shanks
    vSep = 15;   % in um
    hSep = 32;

    elecPos = zeros(nElec, 2);   

    elecPos(1:2:end,1) = 0;         %sites 0,2,4...
    elecPos(2:2:end,1) = hSep;      %sites 1,3,5...

    % fill in y values        
    viHalf = (0:(nElec/2-1))';                %row numbers
    elecPos(1:2:end,2) = viHalf * vSep;       %sites 0,2,4...
    elecPos(2:2:end,2) = elecPos(1:2:end,2);  %sites 1,3,5...
    
    cMap = data;  

    f1 = figure('Units','Centimeters','Position',[15,4,10,18]);
    if pType == 21
        % single shank probe. Plot only lowest selected electrode        
        % plot all positions
        minX = min(elecPos(:,1));
        maxX = max(elecPos(:,1));
        xMargin = 8;
        scatter( elecPos(:,1), elecPos(:,2), 150, 'k', 'square' ); hold on;
        scatter( xCoord, yCoord, 100, cMap, 'square', 'filled' );hold on;   
        xlim([minX - xMargin, maxX + xMargin]);
        ylim([-10,10000]);
        colormap cool;
        colorbar;
        title('NP 2.0 single shank view');
        hold off;
    else
        % four shank probe, no multiple connections   
        % replace xCoordinates with shank coordinates (more useful plots)
        elecPos(:,1) = elecPos(:,1)/hSep; % normalize
        offset = 0.1;
        elecPos(:,1) = elecPos(:,1)*2*offset - offset;         
        shankSep = 250;
        newX = xCoord - shankind*shankSep;
        newX = newX/hSep;
        newX = newX*2*offset - offset;
        
        for sI = 0:3
            cc = find(shankind == sI);
            scatter( sI + elecPos(:,1), elecPos(:,2), 30, 'k', 'square' ); hold on;
            scatter( sI + newX(cc), yCoord(cc), 20, cMap(cc), 'square', 'filled' ); hold on; 
        end
        xlim([-2*offset, 3+2*offset]);
        ylim([-10,10000]);
        colormap cool;
        colorbar;
        title('NP2.0 MS shank view');
        xlabel('shank index');
        ylabel('z position (um)');
        xticks([0 1 2 3])
        hold off;
    end

      
end % XY20Coord